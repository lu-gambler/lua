#### 话题引出

一个电商提交订单按钮的涉及用例：

![image-20220420132239720](./接口幂等性.assets/image-20220420132239720.png)

这个用例商品的角度（涉及的上层数据）和提交订单的角度涉及

中间有一个重复提交：是否有做幂等性这个没有接触过故写此文章学习下。



#### 幂等性接口

##### 什么是幂等性接口

任意多次执行所产生的影响均与一次执行的影响相同，如果存在满足 f(f(x)) = f(x)，那么f运算就是幂等的  。

幂等（idempotent、idempotence）是一个数学与计算机学概念，常见于抽象代数中。
在编程中一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。例如，“setTrue()” 函数就是一个幂等函数,无论多次执行，其结果都是一样的，更复杂的操作幂等保证是利用唯一交易号 (流水号) 实现.

任意多次执行所产生的影响均与一次执行的影响相同，这是幂等性的核心特点。其实在我们编程中主要操作就是 CURD，其中读取（Retrieve）操作和删除（Delete）操作是天然幂等的，受影响的就是创建（Create）、更新（Update）。



##### 它解决了什么问题

对于业务中需要考虑幂等性的地方一般都是接口的重复请求，重复请求是指同一个请求因为某些原因被多次提交。导致这个情况会有几种场景：

- 前端重复提交：提交订单，用户快速重复点击多次，造成后端生成多个内容重复的订单。
- 接口超时重试：对于给第三方调用的接口，为了防止网络抖动或其他原因造成请求丢失，这样的接口一般都会设计成超时重试多次。
- 消息重复消费：MQ 消息中间件，消息重复消费。 对于一些业务场景影响比较大的，接口的幂等性是个必须要考虑的问题，例如金钱的交易方面的接口。否则一个错误的、考虑不周的接口可能会给公司带来巨额的金钱损失，那么背锅的肯定是程序员自己了。

##### 幂等性实现方式

###### Token 机制

###### 数据库去重表

###### Redis实现  （缓存）



##### 它将带入什么问题

（暂时未知）

##### 此类题测试应该如何去做



对于这类不能重复点击，或者重复点击会出现错误的。



第一，从产品的业务逻辑设计和实现上，查看是否做了幂等，比如与时间戳进行幂等
第二，遇到支付这些业务的时候，跟多的需要考虑构造支付失败，检查失败之后的处理机制
第三，前端测试，通过快速点击，手动的难以实现，可以使用UI自动化手段进行实现
第四，后端接口调用。使用jmeter或者postman多次重复发送参数相同的请求，查看服务器返回给我们的response

